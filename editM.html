<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô | AUTODIDACTIC</title>
<style>
body {
  font-family: 'Prompt', sans-serif;
  background: linear-gradient(to bottom, #fff, #fee);
  color: #c00;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

/* ===== Header ===== */
header {
  width: 100%;
  background: #c00;
  color: #fff;
  padding: 12px 20px;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}
header a {
  position: absolute;
  left: 20px;
  top: 12px;
  background: rgba(255,255,255,0.2);
  color: #fff;
  padding: 6px 12px;
  border-radius: 8px;
  text-decoration: none;
}
header a:hover { background: rgba(255,255,255,0.35); }

form {
  width: 100%;
  max-width: 520px;
  background: #fff;
  border: 2px solid #c00;
  padding: 25px;
  margin: 30px 0;
  border-radius: 12px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.08);
}
h2 { text-align: center; margin-top: 0; color: #c00; }

.input-line {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  border: 2px solid #c00;
  border-radius: 8px;
  outline: none;
  font-size: 15px;
  color: #c00;
  box-sizing: border-box;
  background: #fff;
}
textarea.input-line { height: 90px; resize: none; }

select.input-line {
  background: #fff;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  border-radius: 8px;
  background: #c00;
  color: #fff;
  font-weight: bold;
  border: none;
  cursor: pointer;
  font-size: 16px;
  transition: 0.3s;
}
button:hover { background: #a00; transform: scale(1.02); }

a.btn-back {
  display: inline-block;
  text-align: center;
  background: #888;
  color: #fff;
  padding: 10px 18px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  margin-top: 8px;
}
a.btn-back:hover { background: #555; }

/* ===== Dropdown ===== */
.dropdown { position: relative; width: 100%; margin-bottom: 12px; }
.dropdown-btn {
  width: 100%;
  padding: 8px 10px;
  border: 2px solid #c00;
  border-radius: 8px;
  background: #fff;
  color: #c00;
  font-size: 15px;
  text-align: left;
  cursor: pointer;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  min-height: 36px;
  align-items: center;
}
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #fff;
  border: 1px solid #c00;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 10;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  padding: 5px;
}
.dropdown-content label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  cursor: pointer;
}
.dropdown-content label:hover { background: #fee; }
.selected-name {
  background: #c00;
  color: #fff;
  border-radius: 12px;
  padding: 2px 6px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
}

footer {
  background: #c00;
  color: #fff;
  text-align: center;
  padding: 10px;
  font-size: 13px;
  margin-top: auto;
  width: 100%;
}
</style>
</head>

<body>

<header>
  <a href="manager.html">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</a>
  ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô | AUTODIDACTIC
</header>

<form id="editForm">
  <input type="hidden" id="eventId">

  <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô:</label>
  <input type="text" id="job" class="input-line" readonly>

  <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô:</label>
  <input type="text" id="jobNumber" class="input-line" readonly>

  <label>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:</label>
  <div class="dropdown">
    <button type="button" class="dropdown-btn" id="titleBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
    <div class="dropdown-content" id="titleList"></div>
  </div>

  <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
  <input type="text" id="location" class="input-line" required  readonly>

  <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:</label>
  <textarea id="details" class="input-line" required></textarea>

  <label>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô:</label>
  <div class="dropdown">
    <button type="button" class="dropdown-btn" id="assignedByBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
    <div class="dropdown-content" id="assignedByList"></div>
  </div>

  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°:</label>
  <input type="date" id="start" class="input-line" required>

  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
  <input type="date" id="end" class="input-line" required>

  <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
  <select id="status" class="input-line">
    <option value="‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
    <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
    <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
  </select>

  <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  <a href="admin.html" class="btn-back">‡∏Å‡∏•‡∏±‡∏ö</a>
</form>

<footer>¬© 2025 AUTODIDACTIC SYSTEM</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCua-GV6L-yz4cQNlSeQwRFNyOvzRQKO9Q",
  authDomain: "events-92057.firebaseapp.com",
  projectId: "events-92057",
  storageBucket: "events-92057.appspot.com",
  messagingSenderId: "33581889849",
  appId: "1:33581889849:web:184cede4ec9f2eb363d0e8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const eventId = params.get("id");

const titleList = document.getElementById("titleList");
const assignedByList = document.getElementById("assignedByList");
const titleBtn = document.getElementById("titleBtn");
const assignedByBtn = document.getElementById("assignedByBtn");

async function loadDropdowns() {
  titleList.innerHTML = "";
  assignedByList.innerHTML = "";

  const workersSnap = await getDocs(collection(db, "workers"));
  workersSnap.forEach(d => {
    const name = d.data().name;
    titleList.innerHTML += `<label><input type="checkbox" value="${name}"> ${name}</label>`;
  });

  const assignersSnap = await getDocs(collection(db, "assigners"));
  assignersSnap.forEach(d => {
    const name = d.data().name;
    assignedByList.innerHTML += `<label><input type="checkbox" value="${name}"> ${name}</label>`;
  });
}

async function loadEventData() {
  if (!eventId) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô URL");
  const ref = doc(db, "events", eventId);
  const snap = await getDoc(ref);
  if (!snap.exists()) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ");

  const data = snap.data();
  document.getElementById("eventId").value = eventId;
  document.getElementById("jobNumber").value = data.jobNumber || "";
  document.getElementById("location").value = data.location || "";
  document.getElementById("details").value = data.details || "";
  document.getElementById("start").value = data.start || "";
  document.getElementById("end").value = data.end || "";
  document.getElementById("status").value = data.status || "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";

  await loadDropdowns();

  titleList.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if (data.workers?.includes(cb.value)) cb.checked = true;
  });
  assignedByList.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if (data.assigners?.includes(cb.value)) cb.checked = true;
  });

  updateDropdownButton(titleList, titleBtn);
  updateDropdownButton(assignedByList, assignedByBtn);
}

document.getElementById("editForm").addEventListener("submit", async e => {
  e.preventDefault();
  const jobNumber = document.getElementById("jobNumber").value.trim();
  const job = document.getElementById("job").value.trim();
  const location = document.getElementById("location").value.trim();
  const details = document.getElementById("details").value.trim();
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;
  const status = document.getElementById("status").value;

  const workers = Array.from(titleList.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);
  const assigners = Array.from(assignedByList.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);

  await updateDoc(doc(db, "events", eventId), {
    jobNumber, job, location, details, start, end, status, workers, assigners
  });

  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  window.location.href = "admin.html";
});

function updateDropdownButton(list, btn) {
  const selected = Array.from(list.querySelectorAll("input:checked")).map(cb => cb.value);
  btn.innerHTML = selected.length ? selected.map(n => `<span class='selected-name'>${n}</span>`).join(" ") : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠";
}

titleBtn.addEventListener("click", () => titleList.style.display = titleList.style.display === "block" ? "none" : "block");
assignedByBtn.addEventListener("click", () => assignedByList.style.display = assignedByList.style.display === "block" ? "none" : "block");
titleList.addEventListener("change", () => updateDropdownButton(titleList, titleBtn));
assignedByList.addEventListener("change", () => updateDropdownButton(assignedByList, assignedByBtn));

loadEventData();
</script>

</body>
</html>
